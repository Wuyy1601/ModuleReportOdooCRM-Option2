<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="looker_embed_template" name="Looker Studio Embed">
        <t>
            <div class="container mt16" style="padding:12px 18px;box-sizing:border-box;overflow-x:auto;">
                <h1 t-esc="connection.name"/>
                <div class="looker-embed" style="width:100%;height:80vh;">
                    <iframe t-att-src="embed_url" style="width:100%;height:100%;border:0;" allowfullscreen="true"></iframe>
                </div>
            </div>
        </t>
    </template>

    <template id="report_template" name="Report Template">
        <t>
            <div class="container mt16" style="padding:12px 18px;box-sizing:border-box;overflow-x:auto;">
                <h1 t-esc="report.name"/>
                <div class="report-chart-container" style="max-width:100%;">
                    <style>
                        .report-chart-container { height: 38vh; max-height: 360px; min-height: 220px; }
                        #looker_report_chart { width:100% !important; height:100% !important; }
                    </style>
                    <canvas id="looker_report_chart"></canvas>
                </div>
            </div>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
                (function(){
                    // inject JSON arrays directly
                    var labels = <t t-raw="labels_json"/> || [];
                    var values = <t t-raw="values_json"/> || [];
                    var ctx = document.getElementById('looker_report_chart').getContext('2d');
                    var chartType = '<t t-esc="report.chart_type"/>' || 'bar';
                    new Chart(ctx, {
                        type: chartType,
                        data: {
                            labels: labels,
                            datasets: [{
                                label: '<t t-esc="report.name"/>',
                                data: values,
                                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                })();
            </script>
        </t>
    </template>
    
    <template id="report_kpi_template_v2" name="KPI Report Template V2">
        <!-- Deprecated - use v3 -->
        <t t-call="CRM_report.report_kpi_template_v3"/>
    </template>
    
    <template id="report_kpi_template_v3" name="KPI Report Template V3">
        <t t-call="website.layout">
            <div class="container-fluid mt-4 px-4" style="background-color: #f8f9fc;">
                <h1 class="h3 mb-4 text-gray-800" t-esc="report.name"/>

                <!-- MAIN CHART - Based on Group By Field Selection -->
                <div class="row">
                    <div class="col-12">
                        <div class="card shadow mb-4 border-primary">
                            <div class="card-header py-3 bg-primary text-white d-flex flex-row align-items-center justify-content-between">
                                <h6 class="m-0 font-weight-bold">
                                    <i class="fa fa-chart-bar mr-2"></i>
                                    Phân tích theo: <t t-esc="group_field_label"/>
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-area" style="height: 450px;">
                                    <canvas id="main_chart"></canvas>
                                </div>
                                <hr/>
                                <div class="mt-3">
                                    <p class="mb-0 text-muted font-italic"><i class="fa fa-info-circle mr-1"></i> <t t-esc="report.description"/></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Data Table -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Detailed Data</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                            <table class="table table-bordered table-striped table-hover table-sm" id="dataTable" width="100%" cellspacing="0">
                                <thead class="thead-light" style="position: sticky; top: 0; z-index: 1;">
                                    <tr>
                                        <th>Name</th>
                                        <th>Customer</th>
                                        <th>Stage</th>
                                        <th>Expected Revenue</th>
                                        <th>Probability</th>
                                        <th>Lost Reason</th>
                                        <th t-if="report.group_field">Group By (<t t-esc="report.group_field"/>)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="detail_data" t-as="row">
                                        <tr>
                                            <td><t t-esc="row.get('name')"/></td>
                                            <td>
                                                <t t-if="row.get('partner_id')">
                                                    <t t-esc="row['partner_id'][1]"/>
                                                </t>
                                            </td>
                                            <td>
                                                <t t-if="row.get('stage_id')">
                                                    <t t-esc="row['stage_id'][1]"/>
                                                </t>
                                            </td>
                                            <td><t t-esc="row.get('expected_revenue')" t-options='{"widget": "monetary", "display_currency": report.env.company.currency_id}'/></td>
                                            <td><t t-esc="row.get('probability')"/>%</td>
                                            <td>
                                                <t t-if="row.get('lost_reason_id')">
                                                    <span class="badge badge-danger"><t t-esc="row['lost_reason_id'][1]"/></span>
                                                </t>
                                            </td>
                                            <td t-if="report.group_field">
                                                <t t-set="g_val" t-value="row.get(report.group_field)"/>
                                                <t t-if="isinstance(g_val, (list, tuple))">
                                                    <t t-esc="g_val[1]"/>
                                                </t>
                                                <t t-else="">
                                                    <t t-esc="g_val"/>
                                                </t>
                                            </td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- KPIs Row 1 -->
                <div class="row">
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-primary shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Leads</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" t-esc="kpi['lead_count']"/>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fa fa-star fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-success shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Opportunities</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" t-esc="kpi['opp_count']"/>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fa fa-trophy fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-secondary shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-secondary text-uppercase mb-1">Customers</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" t-esc="customer_data['total_customers']"/>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fa fa-users fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-info shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Forecast</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" t-esc="kpi['forecast']" t-options='{"widget": "monetary", "display_currency": report.env.company.currency_id}'/>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fa fa-dollar fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- KPIs Row 2 -->
                <div class="row">
                    <div class="col-xl-4 col-md-6 mb-4">
                        <div class="card border-left-success shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Total Won Revenue</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" t-esc="deal_metrics['total_won_revenue']" t-options='{"widget": "monetary", "display_currency": report.env.company.currency_id}'/>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fa fa-money-bill-wave fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-xl-4 col-md-6 mb-4">
                        <div class="card border-left-danger shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Total Lost Revenue</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" t-esc="lost_reason_data['total_lost_revenue']" t-options='{"widget": "monetary", "display_currency": report.env.company.currency_id}'/>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fa fa-times-circle fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-xl-4 col-md-6 mb-4">
                        <div class="card border-left-info shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Avg Probability</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800"><t t-esc="deal_metrics['avg_probability']"/>%</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fa fa-percentage fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Rates -->
                <div class="row">
                    <div class="col-lg-4 mb-4">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Won Rate</h6>
                            </div>
                            <div class="card-body">
                                <h4 class="small font-weight-bold">Won <span class="float-right"><t t-esc="kpi['won_rate']"/>%</span></h4>
                                <div class="progress mb-4">
                                    <div class="progress-bar bg-success" role="progressbar" t-att-style="'width: ' + str(kpi['won_rate']) + '%'" t-att-aria-valuenow="kpi['won_rate']" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 mb-4">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Lost Rate</h6>
                            </div>
                            <div class="card-body">
                                <h4 class="small font-weight-bold">Lost <span class="float-right"><t t-esc="kpi['lost_rate']"/>%</span></h4>
                                <div class="progress mb-4">
                                    <div class="progress-bar bg-danger" role="progressbar" t-att-style="'width: ' + str(kpi['lost_rate']) + '%'" t-att-aria-valuenow="kpi['lost_rate']" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 mb-4">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Conversion Rate</h6>
                            </div>
                            <div class="card-body">
                                <h4 class="small font-weight-bold">Lead to Opp <span class="float-right"><t t-esc="kpi['conversion_rate']"/>%</span></h4>
                                <div class="progress mb-4">
                                    <div class="progress-bar bg-info" role="progressbar" t-att-style="'width: ' + str(kpi['conversion_rate']) + '%'" t-att-aria-valuenow="kpi['conversion_rate']" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Supplementary Charts: Lost Reason, Pipeline, Win/Loss Trend, Customer Level -->
                <div class="row">
                    <!-- Lost Reason Pie Chart -->
                    <div class="col-xl-3 col-lg-6">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                <h6 class="m-0 font-weight-bold text-danger">
                                    <i class="fa fa-chart-pie mr-2"></i>Lost Reason Analysis
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-pie" style="height: 250px;">
                                    <canvas id="lost_reason_chart"></canvas>
                                </div>
                                <hr/>
                                <div class="mt-2 small">
                                    <div class="text-center mb-2">
                                        <span class="font-weight-bold text-danger">Tổng: <t t-esc="lost_reason_data['total_lost']"/> thất bại</span>
                                    </div>
                                    <t t-foreach="lost_reason_data['labels'][:4]" t-as="label">
                                        <div class="d-flex justify-content-between">
                                            <span><i class="fa fa-circle mr-1" t-att-style="'color:' + lost_reason_data['colors'][label_index]"></i><t t-esc="label"/></span>
                                            <span><t t-esc="lost_reason_data['percentages'][label_index]"/>%</span>
                                        </div>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pipeline Value by Stage -->
                    <div class="col-xl-3 col-lg-6">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">
                                    <i class="fa fa-chart-bar mr-2"></i>Pipeline by Stage
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-area" style="height: 250px;">
                                    <canvas id="pipeline_chart"></canvas>
                                </div>
                                <div class="mt-2 text-center">
                                    <span class="small font-weight-bold text-primary">Total: <t t-esc="pipeline_data['total_pipeline']" t-options='{"widget": "monetary", "display_currency": report.env.company.currency_id}'/></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Customer by Level -->
                    <div class="col-xl-3 col-lg-6">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-secondary">
                                    <i class="fa fa-users mr-2"></i>Customer by Level
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-pie" style="height: 250px;">
                                    <canvas id="customer_level_chart"></canvas>
                                </div>
                                <hr/>
                                <div class="mt-2 small">
                                    <div class="text-center mb-2">
                                        <span class="font-weight-bold text-secondary">Tổng: <t t-esc="customer_data['total_customers']"/> khách hàng</span>
                                    </div>
                                    <t t-foreach="customer_data['labels'][:4]" t-as="label">
                                        <div class="d-flex justify-content-between">
                                            <span><i class="fa fa-circle mr-1" t-att-style="'color:' + customer_data['colors'][label_index]"></i><t t-esc="label"/></span>
                                            <span><t t-esc="customer_data['percentages'][label_index]"/>%</span>
                                        </div>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Win/Loss Trend -->
                    <div class="col-xl-3 col-lg-6">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">
                                    <i class="fa fa-chart-line mr-2"></i>Win/Loss Trend
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-area" style="height: 290px;">
                                    <canvas id="trend_chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                <script>
                    (function(){
                        // MAIN CHART - Based on Group By Field
                        var mainCtx = document.getElementById('main_chart').getContext('2d');
                        var labels = <t t-raw="labels_json"/>;
                        var counts = <t t-raw="counts_json"/>;
                        var sums = <t t-raw="sums_json"/>;
                        var chartType = '<t t-esc="report.chart_type or 'bar'"/>';
                        
                        // Generate colors for each bar
                        var barColors = [
                            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', 
                            '#858796', '#5a5c69', '#6610f2', '#fd7e14', '#20c997'
                        ];
                        var bgColors = labels.map((_, i) => barColors[i % barColors.length]);
                        
                        var datasets = [];
                        if (chartType === 'pie') {
                            datasets = [{
                                data: sums.length > 0 &amp;&amp; sums.some(v => v > 0) ? sums : counts,
                                backgroundColor: bgColors,
                                borderWidth: 2,
                                borderColor: '#ffffff',
                            }];
                        } else {
                            datasets = [{
                                label: 'Số lượng',
                                data: counts,
                                backgroundColor: bgColors,
                                borderColor: bgColors,
                                borderWidth: 1,
                                borderRadius: 5,
                                yAxisID: 'y',
                            }];
                            if (sums.length > 0 &amp;&amp; sums.some(v => v > 0)) {
                                datasets.push({
                                    label: 'Giá trị',
                                    data: sums,
                                    type: 'line',
                                    borderColor: '#e74a3b',
                                    backgroundColor: '#e74a3b',
                                    pointRadius: 5,
                                    yAxisID: 'y1',
                                });
                            }
                        }
                        
                        var chartOptions = chartType === 'pie' ? {
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: true, position: 'right' },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            var total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            var percentage = ((context.raw / total) * 100).toFixed(1);
                                            return context.label + ': ' + context.raw + ' (' + percentage + '%)';
                                        }
                                    }
                                }
                            }
                        } : {
                            maintainAspectRatio: false,
                            layout: { padding: { left: 10, right: 25, top: 25, bottom: 0 } },
                            scales: {
                                x: { grid: { display: false }, ticks: { maxTicksLimit: 10 } },
                                y: { type: 'linear', display: true, position: 'left', ticks: { maxTicksLimit: 8 }, grid: { color: "rgb(234, 236, 244)", borderDash: [2] } },
                                y1: { type: 'linear', display: sums.length > 0 &amp;&amp; sums.some(v => v > 0), position: 'right', grid: { drawOnChartArea: false } },
                            },
                            plugins: { legend: { display: true, position: 'top' } }
                        };
                        
                        new Chart(mainCtx, {
                            type: chartType === 'pie' ? 'doughnut' : 'bar',
                            data: { labels: labels, datasets: datasets },
                            options: chartOptions
                        });

                        // Lost Reason Pie Chart
                        var lostCtx = document.getElementById('lost_reason_chart').getContext('2d');
                        var lostLabels = <t t-raw="lost_labels_json"/>;
                        var lostCounts = <t t-raw="lost_counts_json"/>;
                        var lostColors = <t t-raw="lost_colors_json"/>;
                        
                        new Chart(lostCtx, {
                            type: 'doughnut',
                            data: {
                                labels: lostLabels,
                                datasets: [{
                                    data: lostCounts,
                                    backgroundColor: lostColors,
                                    borderWidth: 2,
                                    borderColor: '#ffffff',
                                }]
                            },
                            options: {
                                maintainAspectRatio: false,
                                cutout: '60%',
                                plugins: {
                                    legend: { display: false },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                var total = context.dataset.data.reduce((a, b) => a + b, 0);
                                                var percentage = ((context.raw / total) * 100).toFixed(1);
                                                return context.label + ': ' + context.raw + ' (' + percentage + '%)';
                                            }
                                        }
                                    }
                                }
                            }
                        });

                        // Pipeline Chart
                        var pipelineCtx = document.getElementById('pipeline_chart').getContext('2d');
                        var pipelineLabels = <t t-raw="pipeline_labels_json"/>;
                        var pipelineRevenues = <t t-raw="pipeline_revenues_json"/>;
                        
                        new Chart(pipelineCtx, {
                            type: 'bar',
                            data: {
                                labels: pipelineLabels,
                                datasets: [{
                                    label: 'Revenue',
                                    data: pipelineRevenues,
                                    backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796', '#5a5c69'],
                                    borderRadius: 5,
                                }]
                            },
                            options: {
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: false },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(context.raw);
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    x: { grid: { display: false } },
                                    y: { grid: { color: "rgb(234, 236, 244)", borderDash: [2] }, ticks: { callback: function(value) { return new Intl.NumberFormat('vi-VN', { notation: 'compact' }).format(value); } } }
                                }
                            }
                        });

                        // Win/Loss Trend Chart
                        var trendCtx = document.getElementById('trend_chart').getContext('2d');
                        var trendLabels = <t t-raw="trend_labels_json"/>;
                        var trendWon = <t t-raw="trend_won_json"/>;
                        var trendLost = <t t-raw="trend_lost_json"/>;
                        
                        new Chart(trendCtx, {
                            type: 'line',
                            data: {
                                labels: trendLabels,
                                datasets: [{
                                    label: 'Won',
                                    data: trendWon,
                                    borderColor: '#1cc88a',
                                    backgroundColor: 'rgba(28, 200, 138, 0.1)',
                                    fill: true,
                                    tension: 0.4,
                                }, {
                                    label: 'Lost',
                                    data: trendLost,
                                    borderColor: '#e74a3b',
                                    backgroundColor: 'rgba(231, 74, 59, 0.1)',
                                    fill: true,
                                    tension: 0.4,
                                }]
                            },
                            options: {
                                maintainAspectRatio: false,
                                plugins: { legend: { display: true, position: 'top' } },
                                scales: {
                                    x: { grid: { display: false } },
                                    y: { grid: { color: "rgb(234, 236, 244)", borderDash: [2] }, beginAtZero: true }
                                }
                            }
                        });

                        // Customer Level Chart
                        var customerCtx = document.getElementById('customer_level_chart').getContext('2d');
                        var customerLabels = <t t-raw="customer_labels_json"/>;
                        var customerCounts = <t t-raw="customer_counts_json"/>;
                        var customerColors = <t t-raw="customer_colors_json"/>;
                        
                        new Chart(customerCtx, {
                            type: 'doughnut',
                            data: {
                                labels: customerLabels,
                                datasets: [{
                                    data: customerCounts,
                                    backgroundColor: customerColors,
                                    borderWidth: 2,
                                    borderColor: '#ffffff',
                                }]
                            },
                            options: {
                                maintainAspectRatio: false,
                                cutout: '55%',
                                plugins: {
                                    legend: { display: false },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                var total = context.dataset.data.reduce((a, b) => a + b, 0);
                                                var percentage = ((context.raw / total) * 100).toFixed(1);
                                                return context.label + ': ' + context.raw + ' (' + percentage + '%)';
                                            }
                                        }
                                    }
                                }
                            }
                        });

                    })();
                </script>
            </div>
        </t>
    </template>

    <template id="report_activity_template" name="Activity Report Template">
        <t t-call="website.layout">
            <div class="container-fluid mt-4 px-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3 mb-0 text-gray-800" t-esc="report.name"/>
                </div>

                <div class="row">
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-primary shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Activities</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" t-esc="total"/>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fa fa-calendar fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <t t-foreach="type_counts" t-as="type_count">
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card border-left-success shadow h-100 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1"><t t-esc="type_count['name']"/></div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800" t-esc="type_count['count']"/>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fa fa-tasks fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </div>

                <div class="row">
                    <div class="col-xl-8 col-lg-7">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                <h6 class="m-0 font-weight-bold text-primary">Activity Distribution</h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-area" style="height: 400px;">
                                    <canvas id="activity_chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Detailed Data Table -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Detailed Activities</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                            <table class="table table-bordered table-striped table-hover table-sm" id="activityTable" width="100%" cellspacing="0">
                                <thead class="thead-light" style="position: sticky; top: 0; z-index: 1;">
                                    <tr>
                                        <th>Related Document</th>
                                        <th>Activity Type</th>
                                        <th>Summary</th>
                                        <th>Deadline</th>
                                        <th>Assigned To</th>
                                        <th>Salesperson</th>
                                        <th>State</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="detail_data" t-as="row">
                                        <tr>
                                            <td><t t-esc="row.get('res_name')"/></td>
                                            <td>
                                                <t t-if="row.get('activity_type_id')">
                                                    <t t-esc="row['activity_type_id'][1]"/>
                                                </t>
                                            </td>
                                            <td><t t-esc="row.get('summary')"/></td>
                                            <td><t t-esc="row.get('date_deadline')"/></td>
                                            <td>
                                                <t t-if="row.get('user_id')">
                                                    <t t-esc="row['user_id'][1]"/>
                                                </t>
                                            </td>
                                            <td><t t-esc="row.get('salesperson')"/></td>
                                            <td>
                                                <span t-if="row.get('state') == 'overdue'" class="badge badge-danger">Overdue</span>
                                                <span t-elif="row.get('state') == 'today'" class="badge badge-warning">Today</span>
                                                <span t-elif="row.get('state') == 'planned'" class="badge badge-success">Planned</span>
                                                <span t-else=""><t t-esc="row.get('state')"/></span>
                                            </td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                <script>
                    (function(){
                        var ctx = document.getElementById('activity_chart').getContext('2d');
                        var labels = <t t-raw="labels_json"/>;
                        var values = <t t-raw="values_json"/>;
                        
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Count',
                                    data: values,
                                    backgroundColor: '#4e73df',
                                    hoverBackgroundColor: '#2e59d9',
                                    borderColor: '#4e73df',
                                }]
                            },
                            options: {
                                maintainAspectRatio: false,
                                layout: {
                                    padding: {
                                        left: 10,
                                        right: 25,
                                        top: 25,
                                        bottom: 0
                                    }
                                },
                                scales: {
                                    x: {
                                        grid: {
                                            display: false,
                                            drawBorder: false
                                        },
                                        ticks: {
                                            maxTicksLimit: 6
                                        }
                                    },
                                    y: {
                                        ticks: {
                                            maxTicksLimit: 5,
                                            padding: 10,
                                        },
                                        grid: {
                                            color: "rgb(234, 236, 244)",
                                            zeroLineColor: "rgb(234, 236, 244)",
                                            drawBorder: false,
                                            borderDash: [2],
                                            zeroLineBorderDash: [2]
                                        }
                                    },
                                },
                                legend: {
                                    display: false
                                },
                                tooltips: {
                                    backgroundColor: "rgb(255,255,255)",
                                    bodyFontColor: "#858796",
                                    titleMarginBottom: 10,
                                    titleFontColor: '#6e707e',
                                    titleFontSize: 14,
                                    borderColor: '#dddfeb',
                                    borderWidth: 1,
                                    xPadding: 15,
                                    yPadding: 15,
                                    displayColors: false,
                                    intersect: false,
                                    mode: 'index',
                                    caretPadding: 10,
                                }
                            }
                        });
                    })();
                </script>
            </div>
        </t>
    </template>
    
    <!-- Sales Performance Report Template V2 -->
    <template id="report_sales_performance_template_v2" name="Sales Performance Report Template V2">
        <t t-call="website.layout">
            <div class="container-fluid mt-4 px-4" style="background-color: #f8f9fc;">
                <h1 class="h3 mb-4 text-gray-800" t-esc="report.name"/>
                
                <!-- Filter Info -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow">
                            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                <h6 class="m-0 font-weight-bold text-primary">Sales Performance by Salesperson</h6>
                                <div>
                                    <span class="badge bg-secondary text-white me-2">
                                        Group by: <t t-esc="salesperson_filter"/>
                                    </span>
                                    <span class="badge bg-info text-white">
                                        <t t-esc="time_filter_display"/>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Top KPIs Row -->
                <div class="row mb-4">
                    <!-- Total Revenue -->
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-primary shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Revenue</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                                            <t t-esc="'{:,.0f}'.format(total_revenue)"/> VND
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Total Won -->
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-success shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Total Won Deals</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                                            <t t-esc="total_won"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Total Lost -->
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-danger shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Total Lost Deals</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                                            <t t-esc="total_lost"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Win Rate -->
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-info shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Win Rate</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                                            <t t-esc="'{:.1f}'.format(avg_win_rate)"/>%
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Revenue by Salesperson Chart -->
                <div class="row mb-4">
                    <div class="col-xl-8 col-lg-7">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Revenue by Salesperson</h6>
                            </div>
                            <div class="card-body">
                                <div style="height: 320px;">
                                    <canvas id="revenueChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Win Rate Chart -->
                    <div class="col-xl-4 col-lg-5">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Win Rate by Salesperson</h6>
                            </div>
                            <div class="card-body">
                                <div style="height: 320px;">
                                    <canvas id="winRateChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Conversion Rate Chart and Quotation Stats -->
                <div class="row mb-4">
                    <div class="col-xl-6 col-lg-6">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Lead → Opportunity Conversion Rate</h6>
                            </div>
                            <div class="card-body">
                                <div style="height: 280px;">
                                    <canvas id="conversionChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-6 col-lg-6">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Quotations by Salesperson</h6>
                            </div>
                            <div class="card-body">
                                <div style="height: 280px;">
                                    <canvas id="quotationChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Detailed Performance Table -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Detailed Salesperson Performance</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover" id="performanceTable" width="100%" cellspacing="0">
                                        <thead class="thead-light">
                                            <tr>
                                                <th>Salesperson</th>
                                                <th class="text-center">Leads</th>
                                                <th class="text-center">Opportunities</th>
                                                <th class="text-center">Won</th>
                                                <th class="text-center">Lost</th>
                                                <th class="text-center">Conversion Rate</th>
                                                <th class="text-center">Win Rate</th>
                                                <th class="text-right">Revenue</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="salesperson_performance" t-as="sp">
                                                <tr>
                                                    <td><strong><t t-esc="sp['name']"/></strong></td>
                                                    <td class="text-center"><t t-esc="sp['leads']"/></td>
                                                    <td class="text-center"><t t-esc="sp['opportunities']"/></td>
                                                    <td class="text-center text-success"><t t-esc="sp['won']"/></td>
                                                    <td class="text-center text-danger"><t t-esc="sp['lost']"/></td>
                                                    <td class="text-center">
                                                        <span t-attf-class="badge #{sp['lead_to_opp_rate'] >= 50 and 'bg-success' or sp['lead_to_opp_rate'] >= 25 and 'bg-warning' or 'bg-danger'}" style="font-size: 0.9em;">
                                                            <t t-esc="'{:.1f}'.format(sp['lead_to_opp_rate'])"/>%
                                                        </span>
                                                    </td>
                                                    <td class="text-center">
                                                        <span t-attf-class="badge #{sp['win_rate'] >= 50 and 'bg-success' or sp['win_rate'] >= 25 and 'bg-warning' or 'bg-danger'}" style="font-size: 0.9em;">
                                                            <t t-esc="'{:.1f}'.format(sp['win_rate'])"/>%
                                                        </span>
                                                    </td>
                                                    <td class="text-right">
                                                        <strong><t t-esc="'{:,.0f}'.format(sp['won_revenue'])"/> VND</strong>
                                                    </td>
                                                </tr>
                                            </t>
                                        </tbody>
                                        <tfoot class="thead-dark">
                                            <tr>
                                                <th>TOTAL</th>
                                                <th class="text-center"><t t-esc="total_leads"/></th>
                                                <th class="text-center"><t t-esc="total_opportunities"/></th>
                                                <th class="text-center"><t t-esc="total_won"/></th>
                                                <th class="text-center"><t t-esc="total_lost"/></th>
                                                <th class="text-center">
                                                    <t t-esc="'{:.1f}'.format(avg_conversion_rate)"/>%
                                                </th>
                                                <th class="text-center">
                                                    <t t-esc="'{:.1f}'.format(avg_win_rate)"/>%
                                                </th>
                                                <th class="text-right">
                                                    <t t-esc="'{:,.0f}'.format(total_revenue)"/> VND
                                                </th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
            
            <!-- Chart.js Scripts -->
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
                (function(){
                    var labels = <t t-raw="labels_json"/> || [];
                    var revenues = <t t-raw="revenues_json"/> || [];
                    var winRates = <t t-raw="won_rates_json"/> || [];
                    var conversionRates = <t t-raw="conversion_rates_json"/> || [];
                    var quotationLabels = <t t-raw="quotation_labels_json"/> || [];
                    var quotationCounts = <t t-raw="quotation_counts_json"/> || [];
                    var quotationAmounts = <t t-raw="quotation_amounts_json"/> || [];
                    
                    // Color palette
                    var colors = [
                        'rgba(78, 115, 223, 0.8)',
                        'rgba(28, 200, 138, 0.8)',
                        'rgba(54, 185, 204, 0.8)',
                        'rgba(246, 194, 62, 0.8)',
                        'rgba(231, 74, 59, 0.8)',
                        'rgba(133, 135, 150, 0.8)',
                        'rgba(102, 16, 242, 0.8)',
                        'rgba(253, 126, 20, 0.8)'
                    ];
                    
                    // Revenue Chart
                    var revenueCtx = document.getElementById('revenueChart').getContext('2d');
                    new Chart(revenueCtx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Revenue (VND)',
                                data: revenues,
                                backgroundColor: colors,
                                borderColor: colors.map(c => c.replace('0.8', '1')),
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return value.toLocaleString() + ' VND';
                                        }
                                    }
                                }
                            }
                        }
                    });
                    
                    // Win Rate Chart
                    var winRateCtx = document.getElementById('winRateChart').getContext('2d');
                    new Chart(winRateCtx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: winRates,
                                backgroundColor: colors,
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right',
                                    labels: { boxWidth: 12 }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return context.label + ': ' + context.raw.toFixed(1) + '%';
                                        }
                                    }
                                }
                            }
                        }
                    });
                    
                    // Conversion Rate Chart
                    var conversionCtx = document.getElementById('conversionChart').getContext('2d');
                    new Chart(conversionCtx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Conversion Rate (%)',
                                data: conversionRates,
                                backgroundColor: 'rgba(28, 200, 138, 0.7)',
                                borderColor: 'rgba(28, 200, 138, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: {
                                        callback: function(value) {
                                            return value + '%';
                                        }
                                    }
                                }
                            }
                        }
                    });
                    
                    // Quotation Chart
                    var quotationCtx = document.getElementById('quotationChart').getContext('2d');
                    new Chart(quotationCtx, {
                        type: 'bar',
                        data: {
                            labels: quotationLabels,
                            datasets: [{
                                label: 'Quotation Count',
                                data: quotationCounts,
                                backgroundColor: 'rgba(54, 185, 204, 0.7)',
                                borderColor: 'rgba(54, 185, 204, 1)',
                                borderWidth: 1,
                                yAxisID: 'y'
                            }, {
                                label: 'Amount (VND)',
                                data: quotationAmounts,
                                type: 'line',
                                borderColor: 'rgba(246, 194, 62, 1)',
                                backgroundColor: 'rgba(246, 194, 62, 0.2)',
                                fill: true,
                                yAxisID: 'y1'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false
                            },
                            scales: {
                                y: {
                                    type: 'linear',
                                    position: 'left',
                                    beginAtZero: true,
                                    title: { display: true, text: 'Count' }
                                },
                                y1: {
                                    type: 'linear',
                                    position: 'right',
                                    beginAtZero: true,
                                    grid: { drawOnChartArea: false },
                                    title: { display: true, text: 'Amount (VND)' }
                                }
                            }
                        }
                    });
                })();
            </script>
        </t>
    </template>
</odoo>
