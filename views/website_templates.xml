<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="looker_embed_template" name="Looker Studio Embed">
        <t>
            <div class="container mt16" style="padding:12px 18px;box-sizing:border-box;overflow-x:auto;">
                <h1 t-esc="connection.name"/>
                <div class="looker-embed" style="width:100%;height:80vh;">
                    <iframe t-att-src="embed_url" style="width:100%;height:100%;border:0;" allowfullscreen="true"></iframe>
                </div>
            </div>
        </t>
    </template>

    <template id="report_template" name="Report Template">
        <t>
            <div class="container mt16" style="padding:12px 18px;box-sizing:border-box;overflow-x:auto;">
                <h1 t-esc="report.name"/>
                <div class="report-chart-container" style="max-width:100%;">
                    <style>
                        .report-chart-container { height: 38vh; max-height: 360px; min-height: 220px; }
                        #looker_report_chart { width:100% !important; height:100% !important; }
                    </style>
                    <canvas id="looker_report_chart"></canvas>
                </div>
            </div>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
                (function(){
                    // inject JSON arrays directly
                    var labels = <t t-raw="labels_json"/> || [];
                    var values = <t t-raw="values_json"/> || [];
                    var ctx = document.getElementById('looker_report_chart').getContext('2d');
                    var chartType = '<t t-esc="report.chart_type"/>' || 'bar';
                    new Chart(ctx, {
                        type: chartType,
                        data: {
                            labels: labels,
                            datasets: [{
                                label: '<t t-esc="report.name"/>',
                                data: values,
                                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                })();
            </script>
        </t>
    </template>
    
    <template id="report_kpi_template_v2" name="KPI Report Template V2">
        <t t-call="website.layout">
            <div class="container-fluid mt-4 px-4">
                <h1 class="h3 mb-4 text-gray-800" t-esc="report.name"/>

                <!-- KPIs -->
                <div class="row">
                    <div class="col-xl-4 col-md-6 mb-4">
                        <div class="card border-left-primary shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Leads</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" t-esc="kpi['lead_count']"/>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fa fa-star fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-xl-4 col-md-6 mb-4">
                        <div class="card border-left-success shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Opportunities</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" t-esc="kpi['opp_count']"/>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fa fa-trophy fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-xl-4 col-md-6 mb-4">
                        <div class="card border-left-info shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Forecast</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" t-esc="kpi['forecast']" t-options='{"widget": "monetary", "display_currency": report.env.company.currency_id}'/>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fa fa-dollar fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Rates -->
                <div class="row">
                    <div class="col-lg-4 mb-4">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Won Rate</h6>
                            </div>
                            <div class="card-body">
                                <h4 class="small font-weight-bold">Won <span class="float-right"><t t-esc="kpi['won_rate']"/>%</span></h4>
                                <div class="progress mb-4">
                                    <div class="progress-bar bg-success" role="progressbar" t-att-style="'width: ' + str(kpi['won_rate']) + '%'" t-att-aria-valuenow="kpi['won_rate']" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 mb-4">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Lost Rate</h6>
                            </div>
                            <div class="card-body">
                                <h4 class="small font-weight-bold">Lost <span class="float-right"><t t-esc="kpi['lost_rate']"/>%</span></h4>
                                <div class="progress mb-4">
                                    <div class="progress-bar bg-danger" role="progressbar" t-att-style="'width: ' + str(kpi['lost_rate']) + '%'" t-att-aria-valuenow="kpi['lost_rate']" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 mb-4">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Conversion Rate</h6>
                            </div>
                            <div class="card-body">
                                <h4 class="small font-weight-bold">Lead to Opp <span class="float-right"><t t-esc="kpi['conversion_rate']"/>%</span></h4>
                                <div class="progress mb-4">
                                    <div class="progress-bar bg-info" role="progressbar" t-att-style="'width: ' + str(kpi['conversion_rate']) + '%'" t-att-aria-valuenow="kpi['conversion_rate']" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart -->
                <div class="row">
                    <div class="col-12">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                <h6 class="m-0 font-weight-bold text-primary">Overview Chart</h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-area" style="height: 400px;">
                                    <canvas id="kpi_chart"></canvas>
                                </div>
                                <hr/>
                                <div class="mt-3">
                                    <p class="mb-0 text-muted font-italic"><i class="fa fa-info-circle mr-1"></i> <t t-esc="report.description"/></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Data Table -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Detailed Data</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                            <table class="table table-bordered table-striped table-hover table-sm" id="dataTable" width="100%" cellspacing="0">
                                <thead class="thead-light" style="position: sticky; top: 0; z-index: 1;">
                                    <tr>
                                        <th>Name</th>
                                        <th>Customer</th>
                                        <th>Stage</th>
                                        <th>Expected Revenue</th>
                                        <th>Probability</th>
                                        <th>Lost Reason</th>
                                        <th t-if="report.group_field">Group By (<t t-esc="report.group_field"/>)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="detail_data" t-as="row">
                                        <tr>
                                            <td><t t-esc="row.get('name')"/></td>
                                            <td>
                                                <t t-if="row.get('partner_id')">
                                                    <t t-esc="row['partner_id'][1]"/>
                                                </t>
                                            </td>
                                            <td>
                                                <t t-if="row.get('stage_id')">
                                                    <t t-esc="row['stage_id'][1]"/>
                                                </t>
                                            </td>
                                            <td><t t-esc="row.get('expected_revenue')" t-options='{"widget": "monetary", "display_currency": report.env.company.currency_id}'/></td>
                                            <td><t t-esc="row.get('probability')"/>%</td>
                                            <td>
                                                <t t-if="row.get('lost_reason_id')">
                                                    <t t-esc="row['lost_reason_id'][1]"/>
                                                </t>
                                            </td>
                                            <td t-if="report.group_field">
                                                <t t-set="g_val" t-value="row.get(report.group_field)"/>
                                                <t t-if="isinstance(g_val, (list, tuple))">
                                                    <t t-esc="g_val[1]"/>
                                                </t>
                                                <t t-else="">
                                                    <t t-esc="g_val"/>
                                                </t>
                                            </td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                <script>
                    (function(){
                        var ctx = document.getElementById('kpi_chart').getContext('2d');
                        var labels = <t t-raw="labels_json"/>;
                        var counts = <t t-raw="counts_json"/>;
                        var sums = <t t-raw="sums_json"/>;
                        
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Count',
                                    data: counts,
                                    backgroundColor: '#4e73df',
                                    hoverBackgroundColor: '#2e59d9',
                                    borderColor: '#4e73df',
                                    yAxisID: 'y',
                                }, {
                                    label: 'Value',
                                    data: sums,
                                    type: 'line',
                                    borderColor: '#1cc88a',
                                    pointBackgroundColor: '#1cc88a',
                                    pointBorderColor: '#1cc88a',
                                    yAxisID: 'y1',
                                }]
                            },
                            options: {
                                maintainAspectRatio: false,
                                layout: {
                                    padding: {
                                        left: 10,
                                        right: 25,
                                        top: 25,
                                        bottom: 0
                                    }
                                },
                                scales: {
                                    x: {
                                        grid: {
                                            display: false,
                                            drawBorder: false
                                        },
                                        ticks: {
                                            maxTicksLimit: 6
                                        }
                                    },
                                    y: {
                                        type: 'linear',
                                        display: true,
                                        position: 'left',
                                        ticks: {
                                            maxTicksLimit: 5,
                                            padding: 10,
                                        },
                                        grid: {
                                            color: "rgb(234, 236, 244)",
                                            zeroLineColor: "rgb(234, 236, 244)",
                                            drawBorder: false,
                                            borderDash: [2],
                                            zeroLineBorderDash: [2]
                                        }
                                    },
                                    y1: {
                                        type: 'linear',
                                        display: true,
                                        position: 'right',
                                        grid: {
                                            drawOnChartArea: false,
                                        },
                                    },
                                },
                                legend: {
                                    display: true
                                },
                                tooltips: {
                                    backgroundColor: "rgb(255,255,255)",
                                    bodyFontColor: "#858796",
                                    titleMarginBottom: 10,
                                    titleFontColor: '#6e707e',
                                    titleFontSize: 14,
                                    borderColor: '#dddfeb',
                                    borderWidth: 1,
                                    xPadding: 15,
                                    yPadding: 15,
                                    displayColors: false,
                                    intersect: false,
                                    mode: 'index',
                                    caretPadding: 10,
                                }
                            }
                        });
                    })();
                </script>
            </div>
        </t>
    </template>

    <template id="report_activity_template" name="Activity Report Template">
        <t t-call="website.layout">
            <div class="container-fluid mt-4 px-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3 mb-0 text-gray-800" t-esc="report.name"/>
                </div>

                <div class="row">
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-primary shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Activities</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" t-esc="total"/>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fa fa-calendar fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <t t-foreach="type_counts" t-as="type_count">
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="card border-left-success shadow h-100 py-2">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1"><t t-esc="type_count['name']"/></div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800" t-esc="type_count['count']"/>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fa fa-tasks fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </div>

                <div class="row">
                    <div class="col-xl-8 col-lg-7">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                <h6 class="m-0 font-weight-bold text-primary">Activity Distribution</h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-area" style="height: 400px;">
                                    <canvas id="activity_chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Detailed Data Table -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Detailed Activities</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                            <table class="table table-bordered table-striped table-hover table-sm" id="activityTable" width="100%" cellspacing="0">
                                <thead class="thead-light" style="position: sticky; top: 0; z-index: 1;">
                                    <tr>
                                        <th>Related Document</th>
                                        <th>Activity Type</th>
                                        <th>Summary</th>
                                        <th>Deadline</th>
                                        <th>Assigned To</th>
                                        <th>Salesperson</th>
                                        <th>State</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="detail_data" t-as="row">
                                        <tr>
                                            <td><t t-esc="row.get('res_name')"/></td>
                                            <td>
                                                <t t-if="row.get('activity_type_id')">
                                                    <t t-esc="row['activity_type_id'][1]"/>
                                                </t>
                                            </td>
                                            <td><t t-esc="row.get('summary')"/></td>
                                            <td><t t-esc="row.get('date_deadline')"/></td>
                                            <td>
                                                <t t-if="row.get('user_id')">
                                                    <t t-esc="row['user_id'][1]"/>
                                                </t>
                                            </td>
                                            <td><t t-esc="row.get('salesperson')"/></td>
                                            <td>
                                                <span t-if="row.get('state') == 'overdue'" class="badge badge-danger">Overdue</span>
                                                <span t-elif="row.get('state') == 'today'" class="badge badge-warning">Today</span>
                                                <span t-elif="row.get('state') == 'planned'" class="badge badge-success">Planned</span>
                                                <span t-else=""><t t-esc="row.get('state')"/></span>
                                            </td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                <script>
                    (function(){
                        var ctx = document.getElementById('activity_chart').getContext('2d');
                        var labels = <t t-raw="labels_json"/>;
                        var values = <t t-raw="values_json"/>;
                        
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Count',
                                    data: values,
                                    backgroundColor: '#4e73df',
                                    hoverBackgroundColor: '#2e59d9',
                                    borderColor: '#4e73df',
                                }]
                            },
                            options: {
                                maintainAspectRatio: false,
                                layout: {
                                    padding: {
                                        left: 10,
                                        right: 25,
                                        top: 25,
                                        bottom: 0
                                    }
                                },
                                scales: {
                                    x: {
                                        grid: {
                                            display: false,
                                            drawBorder: false
                                        },
                                        ticks: {
                                            maxTicksLimit: 6
                                        }
                                    },
                                    y: {
                                        ticks: {
                                            maxTicksLimit: 5,
                                            padding: 10,
                                        },
                                        grid: {
                                            color: "rgb(234, 236, 244)",
                                            zeroLineColor: "rgb(234, 236, 244)",
                                            drawBorder: false,
                                            borderDash: [2],
                                            zeroLineBorderDash: [2]
                                        }
                                    },
                                },
                                legend: {
                                    display: false
                                },
                                tooltips: {
                                    backgroundColor: "rgb(255,255,255)",
                                    bodyFontColor: "#858796",
                                    titleMarginBottom: 10,
                                    titleFontColor: '#6e707e',
                                    titleFontSize: 14,
                                    borderColor: '#dddfeb',
                                    borderWidth: 1,
                                    xPadding: 15,
                                    yPadding: 15,
                                    displayColors: false,
                                    intersect: false,
                                    mode: 'index',
                                    caretPadding: 10,
                                }
                            }
                        });
                    })();
                </script>
            </div>
        </t>
    </template>
</odoo>
